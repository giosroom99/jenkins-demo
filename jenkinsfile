pipeline {
    agent any
    environment {
        JIRA_URL = 'https://injam2024.atlassian.net/'
        JIRA_USER = 'giotshibangu@gmail.com'  
    }
    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout the code from GitHub
                    git branch: 'main', url: 'https://github.com/giosroom99/jenkins-demo.git'
                    
                    // Extract the branch name and set it as an environment variable
                    env.JIRA_ISSUE = env.GIT_BRANCH.substring(env.GIT_BRANCH.lastIndexOf("/") + 1)
                }
            }
        }
        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }
        stage('Run Tests') {
            steps {
                script {
                    // Capture test results or logs
                    try {
                        def testLog = sh(script: 'npm test', returnStdout: true).trim()
                        env.TEST_LOG = testLog
                    } catch (Exception e) {
                        echo "Tests failed: ${e.message}"
                        env.TEST_LOG = "Tests failed: ${e.message}"
                    }
                }
            }
        }
    }
    post {
        always {
            script {
                // Ensure results are posted to JIRA even if previous stages failed
                if (!env.TEST_LOG) {
                    env.TEST_LOG = "No test logs available"
                }
                
                withCredentials([string(credentialsId: 'jira-api-token', variable: 'JIRA_API_TOKEN')]) {
                    def escapedTestLog = env.TEST_LOG.replaceAll('(["\\\\])', '\\\\$1').replaceAll('\n', '\\n')
                    
                    def curlCommand = """
                        curl -X POST \
                        -H "Content-Type: application/json" \
                        -u ${JIRA_USER}:${JIRA_API_TOKEN} \
                        -d '{"body": "${escapedTestLog}"}' \
                        ${JIRA_URL}/rest/api/2/issue/${env.JIRA_ISSUE}/comment
                    """
                    
                    sh curlCommand
                }
            }
        }
    }
}
